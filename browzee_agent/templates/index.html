<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>AI Web Search Agent</title>
    <link href="https://fonts.googleapis.com/css?family=Roboto:400,700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Roboto', Arial, sans-serif;
            background: #f5f7fa;
            margin: 0;
            padding: 0;
        }
        .container {
            max-width: 900px;
            margin: 40px auto;
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(60,60,120,0.12);
            padding: 32px 40px 40px 40px;
        }
        h2 {
            margin-top: 0;
            font-size: 2.2em;
            letter-spacing: 1px;
            color: #2d3748;
        }
        form {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-bottom: 24px;
        }
        input[type="text"], select {
            padding: 10px 12px;
            border: 1px solid #cbd5e1;
            border-radius: 6px;
            font-size: 1em;
            outline: none;
            transition: border 0.2s;
        }
        input[type="text"]:focus, select:focus {
            border: 1.5px solid #6366f1;
        }
        button {
            padding: 10px 24px;
            background: linear-gradient(90deg, #6366f1 0%, #60a5fa 100%);
            color: #fff;
            border: none;
            border-radius: 6px;
            font-size: 1em;
            font-weight: 700;
            cursor: pointer;
            transition: background 0.2s;
        }
        button:hover {
            background: linear-gradient(90deg, #60a5fa 0%, #6366f1 100%);
        }
        #result {
            margin-top: 24px;
            background: #f8fafc;
            border-radius: 10px;
            padding: 24px;
            min-height: 60px;
            box-shadow: 0 2px 8px rgba(60,60,120,0.06);
        }
        ol {
            padding-left: 20px;
        }
        li {
            margin-bottom: 28px;
            font-size: 1.08em;
            line-height: 1.6;
        }
        .result-title {
            font-size: 1.18em;
            font-weight: 700;
            color: #3b82f6;
            text-decoration: none;
            transition: color 0.2s;
        }
        .result-title:hover {
            color: #6366f1;
            text-decoration: underline;
        }
        .score-badges {
            margin-top: 6px;
            display: flex;
            gap: 12px;
        }
        .badge {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.95em;
            font-weight: 500;
            background: #e0e7ff;
            color: #3730a3;
        }
        .badge.reliability {
            background: #d1fae5;
            color: #047857;
        }
        .badge.relevance {
            background: #fee2e2;
            color: #b91c1c;
        }
        @media (max-width: 700px) {
            .container { padding: 16px; }
            form { flex-direction: column; gap: 8px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h2>AI Web Search Agent</h2>
        <form id="searchForm">
            <input type="text" id="query" placeholder="Enter your search query" required>
            <button type="submit">Search</button>
        </form>
        <div id="result"></div>
    </div>
    <script>
    let lastResults = [];

    function renderAnswer(answer, tasks) {
        const resultDiv = document.getElementById("result");
        if (!answer || answer.trim() === "") {
            resultDiv.innerHTML = "<p>No answer found.</p>";
            return;
        }

        // Extract sources from the end of the answer
        let sources = {};
        let mainText = answer;
        const sourcesMatch = answer.match(/Sources?:\s*([\s\S]*)/i);
        if (sourcesMatch) {
            mainText = answer.slice(0, sourcesMatch.index).trim();
            const sourcesText = sourcesMatch[1].trim();
            const sourceLines = sourcesText.split(/\n|<br\s*\/?>/).map(l => l.trim()).filter(l => l);
            for (const line of sourceLines) {
                const m = line.match(/(\d+)\.\s*(https?:\/\/\S+)/);
                if (m) {
                    sources[`source${m[1]}`] = m[2];
                }
            }
        }

        // Replace [sourceX] with clickable links
        mainText = mainText.replace(/\[source(\d+)\]/g, (match, p1) => {
            const url = sources[`source${p1}`];
            if (url) {
                return `<a href=\"${url}\" target=\"_blank\" style=\"color:#6366f1;text-decoration:underline;\">[source${p1}]</a>`;
            }
            return match;
        });

        let html = `<div style=\"font-size:1.15em;line-height:1.7;\">${mainText}</div>`;
        if (tasks && tasks.trim() !== "") {
            // Split tasks by lines starting with 1., 2., 3.
            let taskList = [];
            const regex = /\d+\.\s*([\s\S]*?)(?=\n\d+\.|$)/g;
            let match;
            while ((match = regex.exec(tasks)) !== null) {
                const task = match[1].trim();
                if (task) taskList.push(task);
            }
            html += `<div style=\"margin-top:2em;\"><b>Suggested Next Steps:</b><div id=\"task-panels\" style=\"display:flex;flex-wrap:wrap;gap:16px;margin-top:12px;\">`;
            for (let i = 0; i < taskList.length; i++) {
                const task = taskList[i];
                html += `<div class=\"task-panel\" data-task=\"${encodeURIComponent(task)}\" style=\"background:#e0e7ef;padding:16px 18px;border-radius:10px;box-shadow:0 1px 4px rgba(60,60,120,0.08);min-width:220px;flex:1 1 220px;cursor:pointer;transition:background 0.2s;\">${task}</div>`;
            }
            html += `</div></div>`;
        }
        resultDiv.innerHTML = html;

        // Add click handlers to each task panel
        const panels = document.querySelectorAll('.task-panel');
        panels.forEach(panel => {
            panel.onclick = async function() {
                const taskText = decodeURIComponent(this.getAttribute('data-task'));
                this.style.background = '#c7d2fe';
                this.innerHTML = 'Running task...';
                try {
                    const resp = await fetch('http://127.0.0.1:8000/run-task', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ task: taskText, mode: 'task' })
                    });
                    const data = await resp.json();
                    this.innerHTML = 'Task triggered!';
                } catch (e) {
                    this.innerHTML = 'Error triggering task.';
                }
            };
        });
    }

    document.getElementById("searchForm").onsubmit = async function(e) {
        e.preventDefault();
        const query = document.getElementById("query").value;
        document.getElementById("result").textContent = "Searching...";
        const response = await fetch("/search", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ query })
        });
        const data = await response.json();
        renderAnswer(data.answer, data.tasks);
    };
    </script>
</body>
</html>
